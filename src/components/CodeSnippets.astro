---
import { Code } from '@astrojs/starlight/components';
import { SnippetSelector } from './react/api/SnippetSelector';

export interface CodeExample {
  language: string;
  code: string;
  title?: string;
}

interface Props {
  examples: CodeExample[];
  response?: string;
  title?: string;
}

const { examples, response, title } = Astro.props;

// Map language identifiers to Code component lang prop
function getLang(language: string): string {
  const langMap: Record<string, string> = {
    cli: 'bash',
    bash: 'bash',
    curl: 'bash',
    go: 'go',
    javascript: 'typescript',
    typescript: 'typescript',
    python: 'python',
    elixir: 'elixir',
    json: 'json',
  };
  return langMap[language] || 'text';
}

const availableLanguages = examples.map(e => e.language);
const defaultLanguage = availableLanguages.includes('cli') ? 'cli' : availableLanguages[0] || 'cli';
---

<div class="code-snippets flex flex-col gap-4" data-default-language={defaultLanguage}>
  <!-- Request Section -->
  <div class="rounded-xl border border-[var(--snippet-border)] bg-[var(--snippet-bg)]">
    <!-- Header -->
    <div class="snippet-header flex items-center justify-between gap-4 pl-4 pr-2 py-1.5 min-h-10 bg-[var(--snippet-header-bg)] border-b border-[var(--snippet-border)] rounded-t-xl">
      <span class="text-[0.8125rem] font-medium text-[var(--sl-color-text)] leading-none">{title || 'Request'}</span>
      <SnippetSelector
        client:load
        languages={availableLanguages}
        defaultLanguage={defaultLanguage}
      />
    </div>
    <!-- Code blocks -->
    <div class="relative overflow-hidden rounded-b-xl">
      {examples.map((example) => (
        <div
          class="code-snippet-block hidden"
          data-language={example.language}
        >
          <Code code={example.code} lang={getLang(example.language)} />
        </div>
      ))}
    </div>
  </div>

  <!-- Response Section -->
  {response && (
    <div class="rounded-xl border border-[var(--snippet-border)] overflow-hidden bg-[var(--snippet-bg)]">
      <div class="flex items-center gap-2 px-4 h-10 bg-[var(--snippet-header-bg)] border-b border-[var(--snippet-border)]">
        <span class="text-[0.8125rem] font-medium text-[var(--sl-color-text)]">Response</span>
      </div>
      <div>
        <Code code={response} lang="json" />
      </div>
    </div>
  )}
</div>

<style>
  /* Reset margins for header children (astro-island, script, etc. inherit margin from .sl-markdown-content) */
  .snippet-header :global(*) {
    margin: 0 !important;
  }

  /* Override Expressive Code styles inside snippet cards */
  .code-snippets :global(.expressive-code) {
    margin: 0;
  }

  .code-snippets :global(.expressive-code figure) {
    margin: 0;
    border: none;
    border-radius: 0;
    background: transparent;
  }

  .code-snippets :global(.expressive-code pre) {
    border: none !important;
    border-radius: 0 !important;
    background: transparent !important;
  }

  .code-snippets :global(.expressive-code .frame) {
    border: none;
    border-radius: 0;
  }

  /* Hide default EC header inside our cards */
  .code-snippets :global(.expressive-code .frame .header) {
    display: none;
  }

  /* Toggle visibility via JavaScript */
  .code-snippet-block {
    display: none;
  }

  .code-snippet-block.active {
    display: block;
  }
</style>

<script>
  const STORAGE_KEY = 'sprites-docs-language-preference';

  // Get stored language preference or use default
  function getStoredLanguage(): string | null {
    try {
      return localStorage.getItem(STORAGE_KEY);
    } catch {
      return null;
    }
  }

  // Initialize: apply stored language preference to all snippets
  function initializeLanguagePreference() {
    const storedLang = getStoredLanguage();

    document.querySelectorAll('.code-snippets').forEach(container => {
      const defaultLang = container.getAttribute('data-default-language') || 'cli';

      // Determine which language to show
      let targetLang = storedLang || defaultLang;

      // Check if the stored language is available in this snippet
      const availableBlocks = container.querySelectorAll('.code-snippet-block');
      const availableLangs = Array.from(availableBlocks).map(b => b.getAttribute('data-language'));

      if (!availableLangs.includes(targetLang)) {
        // Fall back to default if stored lang not available
        targetLang = defaultLang;
      }

      // Hide all and show target
      availableBlocks.forEach(block => {
        block.classList.remove('active');
        if (block.getAttribute('data-language') === targetLang) {
          block.classList.add('active');
        }
      });

      // Update the selector if it exists
      container.setAttribute('data-current-language', targetLang);
    });
  }

  // Listen for language changes from SnippetSelector
  document.addEventListener('language-preference-changed', ((event: CustomEvent) => {
    const newLang = event.detail.language;

    // Update all code snippets on the page
    document.querySelectorAll('.code-snippets').forEach(container => {
      const availableBlocks = container.querySelectorAll('.code-snippet-block');
      const availableLangs = Array.from(availableBlocks).map(b => b.getAttribute('data-language'));

      // Only switch if this snippet has the selected language
      if (availableLangs.includes(newLang)) {
        availableBlocks.forEach(block => {
          block.classList.remove('active');
          if (block.getAttribute('data-language') === newLang) {
            block.classList.add('active');
          }
        });
        container.setAttribute('data-current-language', newLang);
      }
    });
  }) as EventListener);

  // Run on page load
  initializeLanguagePreference();
</script>
