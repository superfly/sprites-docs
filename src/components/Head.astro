---
import Default from '@astrojs/starlight/components/Head.astro';

const siteUrl = 'https://docs.sprites.dev';
const pageTitle = Astro.locals.starlightRoute?.entry?.data?.title ?? 'Sprites Documentation';
const ogImageUrl = `https://og-images.fly.dev/image?template=sprites&text=${encodeURIComponent(pageTitle)}`;
const slug = Astro.locals.starlightRoute?.slug ?? Astro.locals.starlightRoute?.id;
const isHomePage = slug === '' || slug === 'index' || slug === 'index.mdx';

const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Sprites Documentation',
  url: siteUrl,
};

// Build breadcrumbs from URL path
const formatSegment = (segment: string) =>
  segment
    .split('-')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');

const pathSegments = (slug || '')
  .replace(/\.mdx?$/, '')
  .split('/')
  .filter(Boolean);

const breadcrumbItems = [
  { name: 'Sprites Documentation', url: siteUrl },
  ...pathSegments.slice(0, -1).map((segment, index) => ({
    name: formatSegment(segment),
    url: `${siteUrl}/${pathSegments.slice(0, index + 1).join('/')}/`,
  })),
  ...(pathSegments.length > 0
    ? [{ name: pageTitle, url: `${siteUrl}/${pathSegments.join('/')}/` }]
    : []),
];

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: breadcrumbItems.map((item, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    name: item.name,
    item: item.url,
  })),
};
---

<Default {...Astro.props}><slot /></Default>

<!-- Dynamic OG Image -->
<meta property="og:image" content={ogImageUrl} />
<meta name="twitter:image" content={ogImageUrl} />

{isHomePage && (
  <Fragment set:html={`<script type="application/ld+json">${JSON.stringify(websiteSchema)}</script>`} />
)}

<Fragment set:html={`<script type="application/ld+json">${JSON.stringify(breadcrumbSchema)}</script>`} />

<!-- Custom code block copy button with animated green check -->
<script>
  const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
  const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="check-icon"><path d="M5 12l5 5L20 7"/></svg>`;

  function initCopyButtons() {
    document.querySelectorAll('.expressive-code .copy button').forEach((button) => {
      if (button.dataset.customized) return;
      button.dataset.customized = 'true';

      // Store original click handler data
      const code = button.dataset.code || '';

      // Replace button content with custom icons
      button.innerHTML = `
        <span class="copy-icon-wrapper">${copyIcon}</span>
        <span class="check-icon-wrapper">${checkIcon}</span>
      `;

      // Add custom click handler
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        try {
          await navigator.clipboard.writeText(code);
          button.classList.add('copied');
          setTimeout(() => button.classList.remove('copied'), 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      }, { capture: true });
    });
  }

  // Run on initial load and page transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCopyButtons);
  } else {
    initCopyButtons();
  }
  document.addEventListener('astro:page-load', initCopyButtons);
</script>
